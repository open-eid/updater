name: CI
on: [push, pull_request]
env:
  BUILD_NUMBER: ${{ github.run_number }}
  CMAKE_BUILD_PARALLEL_LEVEL: 4
jobs:
  macos:
    name: Build on macOS
    runs-on: macos-latest
    env:
      MACOSX_DEPLOYMENT_TARGET: 13.0
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Build
      run: |
        cmake -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -S . -B build
        cmake --build build --target pkgbuild
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macOS
        path: build/*.pkg
  windows:
    name: Build on Windows
    runs-on: windows-2022
    strategy:
      matrix:
        vcver: [143]
    env:
      VER_SUFFIX: .VS${{ matrix.vcver }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Prepare vcpkg
      uses: lukka/run-vcpkg@v7
      with:
        vcpkgArguments: openssl
        vcpkgGitCommitId: 031ad89ce6c575df35a8e58707ad2c898446c63e
        vcpkgTriplet: x64-windows
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: 6.9.1
        arch: win64_msvc2022_64
    - name: Setup dev env
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    - name: Install WiX
      run: |
        dotnet tool install -g wix --version 6.0.1
        wix extension -g add WixToolset.UI.wixext/6.0.1
    - name: Build
      run: |
        cmake -S . -B build `
          -DCMAKE_TOOLCHAIN_FILE=${{ env.RUNVCPKG_VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake
        cmake --build build --target installer
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: msi_${{ matrix.vcver }}_x64
        path: build/*.msi
